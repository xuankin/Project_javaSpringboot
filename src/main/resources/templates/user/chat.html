<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Chat Hỗ Trợ - Motorbike Rental</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body {
            background-color: #f5f7fa;
            height: 100vh;
            overflow: hidden; /* Ngăn cuộn trang chính, chỉ cuộn phần chat */
        }
        .chat-container {
            height: 100%;
            display: flex;
            flex-direction: column;
            max-width: 1000px; /* Giới hạn chiều rộng để nhìn đẹp hơn trên PC */
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
        }
        .chat-header {
            flex-shrink: 0;
            background-color: #0d6efd;
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .chat-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .chat-footer {
            flex-shrink: 0;
            padding: 15px 20px;
            background: white;
            border-top: 1px solid #dee2e6;
        }

        /* Tùy chỉnh thanh cuộn */
        .chat-content::-webkit-scrollbar {
            width: 6px;
        }
        .chat-content::-webkit-scrollbar-thumb {
            background-color: #adb5bd;
            border-radius: 3px;
        }
    </style>
</head>
<body>

<div class="chat-container">
    <div class="chat-header">
        <div class="d-flex align-items-center">
            <div class="bg-white text-primary rounded-circle d-flex justify-content-center align-items-center me-3"
                 style="width: 40px; height: 40px;">
                <i class="fas fa-headset"></i>
            </div>
            <div>
                <h5 class="mb-0 fw-bold">Hỗ trợ khách hàng</h5>
                <small class="text-white-50">Trực tuyến</small>
            </div>
        </div>
        <a href="/" class="btn btn-outline-light btn-sm">
            <i class="fas fa-arrow-left me-1"></i> Quay lại
        </a>
    </div>

    <div class="chat-content" id="chat-content">
        <div class="d-flex justify-content-center mt-5" id="loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>

    <div class="chat-footer">
        <div class="input-group">
            <input type="text" id="chat-input" class="form-control form-control-lg bg-light border-0"
                   placeholder="Nhập tin nhắn..." onkeypress="handleEnter(event)">
            <button class="btn btn-primary px-4" onclick="sendMessage()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script th:inline="javascript">
    /*<![CDATA[*/
    var stompClient = null;

    function connect() {
        var socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.debug = null;

        stompClient.connect({}, function (frame) {
            stompClient.subscribe('/user/queue/reply', function (payload) {
                var message = JSON.parse(payload.body);
                renderMessage("Admin", message.content, false);
            });
        }, function(err) {
            console.error("Lỗi kết nối: " + err);
        });
    }

    function loadHistory() {
        fetch('/api/chat/my-history')
            .then(res => res.json())
            .then(data => {
                document.getElementById('loading').style.display = 'none';
                var chatBox = document.getElementById('chat-content');
                chatBox.innerHTML = '';

                // Tin nhắn chào mừng
                renderMessage("Admin", "Xin chào! Bạn cần hỗ trợ gì về dịch vụ thuê xe không ạ?", false);

                data.forEach(msg => {
                    renderMessage(msg.adminSender ? "Admin" : "Tôi", msg.content, !msg.adminSender);
                });
            })
            .catch(err => console.error(err));
    }

    function sendMessage() {
        var input = document.getElementById('chat-input');
        var content = input.value.trim();
        if(content && stompClient) {
            var chatMessage = {
                content: content,
                type: 'CHAT'
            };
            stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(chatMessage));
            renderMessage("Tôi", content, true);
            input.value = '';
        }
    }

    function renderMessage(sender, content, isSelf) {
        var chatBox = document.getElementById('chat-content');
        var div = document.createElement('div');
        div.className = 'd-flex mb-3 ' + (isSelf ? 'justify-content-end' : 'justify-content-start');

        var avatar = isSelf ? '' : `
            <div class="rounded-circle bg-primary text-white d-flex justify-content-center align-items-center me-2 mt-1 shadow-sm"
                 style="width: 35px; height: 35px; font-size: 12px; flex-shrink: 0;">Ad</div>
        `;

        // Style bong bóng chat đẹp hơn
        var bubbleStyle = isSelf
            ? 'background: #0d6efd; color: white; border-radius: 15px 15px 0 15px;'
            : 'background: white; color: #212529; border: 1px solid #dee2e6; border-radius: 15px 15px 15px 0;';

        div.innerHTML = `
            ${avatar}
            <div class="p-3 shadow-sm" style="max-width: 75%; ${bubbleStyle} word-wrap: break-word;">
                ${content.replace(/\n/g, "<br>")}
            </div>
        `;

        chatBox.appendChild(div);
        scrollToBottom();
    }

    function scrollToBottom() {
        var chatBox = document.getElementById('chat-content');
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function handleEnter(e) {
        if(e.key === 'Enter') sendMessage();
    }

    // Khởi chạy
    connect();
    loadHistory();
    /*]]>*/
</script>
</body>
</html>