<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{fragments/layout}">
<head>
    <title>Hệ thống chi nhánh</title>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css' rel='stylesheet' />
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.1/mapbox-gl-directions.css" type="text/css">
</head>
<body>

<div layout:fragment="content" class="container mt-4">
    <style>
        .branch-card {
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 5px solid transparent;
            border-radius: 8px;
            margin-bottom: 10px;
            background: #fff;
        }
        .branch-card:hover, .branch-card.active {
            background-color: #f0f8ff;
            border-left: 5px solid #0d6efd;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        #map {
            height: 600px;
            width: 100%;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }
        .mapboxgl-ctrl-geocoder { min-width: 100%; }
        .branch-list-container {
            max-height: 600px;
            overflow-y: auto;
            padding-right: 5px;
        }
        /* Tùy chỉnh thanh cuộn */
        .branch-list-container::-webkit-scrollbar { width: 6px; }
        .branch-list-container::-webkit-scrollbar-thumb { background-color: #dee2e6; border-radius: 4px; }
    </style>

    <h2 class="mb-4 text-center fw-bold text-primary">Hệ Thống Chi Nhánh Cửa Hàng</h2>

    <div class="row g-4">
        <div class="col-lg-4 col-md-5">
            <div class="branch-list-container">
                <div class="list-group" id="branchList">
                </div>
            </div>
            <div class="alert alert-info mt-3 shadow-sm border-0 d-flex align-items-center">
                <i class="fas fa-info-circle text-primary me-2 fs-4"></i>
                <small>Chọn "Chỉ đường" để tìm đường từ vị trí của bạn.</small>
            </div>
        </div>

        <div class="col-lg-8 col-md-7">
            <div id="map" class="shadow-lg border bg-light"></div>
        </div>
    </div>
</div>

<th:block layout:fragment="scripts">
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js'></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.1/mapbox-gl-directions.js"></script>

    <script th:inline="javascript">
        /*<![CDATA[*/
        const token = [[${mapboxToken}]];

        // Dữ liệu mẫu (Có thể thay bằng API lấy từ server)
        const branches = [
            { id: 1, name: "Trụ sở Quận 1", address: "Phố đi bộ Nguyễn Huệ, Q.1, TP.HCM", phone: "0901.234.567", coords: [106.703756, 10.774409] },
            { id: 2, name: "CN Thủ Đức", address: "Võ Văn Ngân, Thủ Đức, TP.HCM", phone: "0909.888.999", coords: [106.772054, 10.850632] },
            { id: 3, name: "CN Bình Thạnh", address: "Landmark 81, Bình Thạnh, TP.HCM", phone: "0912.333.444", coords: [106.721835, 10.794715] }
        ];

        if (!token || token.length < 10) {
            console.error("Lỗi: Mapbox Token chưa hợp lệ hoặc chưa được cấu hình.");
        } else {
            mapboxgl.accessToken = token;
            initMap();
        }

        function initMap() {
            const map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/streets-v12',
                center: [106.703756, 10.774409],
                zoom: 12
            });

            map.addControl(new mapboxgl.NavigationControl(), 'bottom-right');

            const geolocateControl = new mapboxgl.GeolocateControl({
                positionOptions: { enableHighAccuracy: true },
                trackUserLocation: true,
                showUserHeading: true
            });
            map.addControl(geolocateControl, 'top-right');

            // Widget Chỉ đường
            const directions = new MapboxDirections({
                accessToken: mapboxgl.accessToken,
                unit: 'metric',
                profile: 'mapbox/driving',
                language: 'vi',
                controls: { inputs: true, instructions: true, profileSwitcher: true },
                placeholderOrigin: 'Vị trí của bạn',
                placeholderDestination: 'Điểm đến...'
            });
            map.addControl(directions, 'top-left');

            // Render danh sách & Markers
            const branchListEl = document.getElementById('branchList');

            branches.forEach(branch => {
                // Render List Item
                const item = document.createElement('div');
                item.className = 'list-group-item list-group-item-action branch-card p-3 shadow-sm border mb-2';
                item.id = `branch-item-${branch.id}`;

                item.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-1 fw-bold text-dark">${branch.name}</h6>
                        <span class="badge bg-secondary rounded-pill">CN ${branch.id}</span>
                    </div>
                    <p class="mb-2 small text-muted"><i class="fas fa-map-marker-alt text-danger me-1"></i>${branch.address}</p>
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-primary fw-bold"><i class="fas fa-phone me-1"></i>${branch.phone}</small>
                        <button class="btn btn-sm btn-outline-primary direct-btn" onclick="selectBranch(${branch.id})">
                            <i class="fas fa-location-arrow me-1"></i> Chỉ đường
                        </button>
                    </div>
                `;
                branchListEl.appendChild(item);

                // Render Map Marker
                const popup = new mapboxgl.Popup({ offset: 25 })
                    .setHTML(`<div class="p-2"><strong>${branch.name}</strong><br><small>${branch.address}</small></div>`);

                new mapboxgl.Marker({ color: '#E63946' })
                    .setLngLat(branch.coords)
                    .setPopup(popup)
                    .addTo(map);
            });

            // --- HÀM XỬ LÝ CHÍNH: CHỈ ĐƯỜNG ---
            window.selectBranch = function(branchId) {
                const selected = branches.find(b => b.id === branchId);
                if (!selected) return;

                // 1. Highlight giao diện
                document.querySelectorAll('.branch-card').forEach(el => el.classList.remove('active'));
                const activeItem = document.getElementById(`branch-item-${branchId}`);
                if(activeItem) activeItem.classList.add('active');

                // 2. Feedback UI (Đổi nút thành Loading)
                const btn = activeItem.querySelector('.direct-btn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang định vị...';
                btn.disabled = true;

                // 3. Set điểm đến trước
                directions.setDestination(selected.coords);

                // 4. Lấy vị trí người dùng
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const userLng = position.coords.longitude;
                            const userLat = position.coords.latitude;

                            // Set Origin = Vị trí người dùng
                            directions.setOrigin([userLng, userLat]);

                            // Reset nút
                            btn.innerHTML = originalText;
                            btn.disabled = false;
                        },
                        (error) => {
                            console.error("Lỗi Geolocation:", error);
                            let msg = "Không thể lấy vị trí của bạn.";
                            if (error.code === 1) msg = "Bạn đã từ chối quyền truy cập vị trí.";
                            alert(msg + " Bản đồ sẽ chỉ hiển thị vị trí cửa hàng.");

                            // Fallback: Chỉ bay đến cửa hàng
                            map.flyTo({ center: selected.coords, zoom: 14 });
                            btn.innerHTML = originalText;
                            btn.disabled = false;
                        },
                        { enableHighAccuracy: true, timeout: 10000 }
                    );
                } else {
                    alert("Trình duyệt của bạn không hỗ trợ định vị.");
                    map.flyTo({ center: selected.coords, zoom: 14 });
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            };
        }
        /*]]>*/
    </script>
</th:block>

</body>
</html>